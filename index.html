<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Design Explorer</title>

    <!-- D3 -->
    <script src="./d3/d3.v3.min.js" charset="utf-8"></script>

    <!-- jQuery -->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <!-- Sliders script and css -->
    <script src="./rangeslider_files/js/ion.rangeSlider.js"></script>
    <link rel="stylesheet" href="./rangeslider_files/css/normalize.css" />
    <link rel="stylesheet" href="./rangeslider_files/css/ion.rangeSlider.css" />
    <link rel="stylesheet" href="./rangeslider_files/css/ion.rangeSlider.skinNice.css"/>

    <!-- Parallel Coordinates -->
    <script type="text/javascript" src = "http://mostapharoudsari.github.io/Honeybee/pc_source_files/d3/d3.parcoords.js"></script>
    
    <!-- D3 Parallel Coordinates CSS -->
    <link rel="stylesheet" type="text/css" href="./pc_source_files/css/d3.parcoords.css">

    <!-- Radar Chart -->
    <script type="text/javascript" src="./radar_source_files/radar-chart.js"></script>

    <!-- Radar Chart CSS -->
    <link rel="stylesheet" type="text/css" href="./radar_source_files/radar-chart.css"/>
    
    <!-- Bootstrap Core CSS -->
    <link href="bootstrap_side_bar/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="bootstrap_side_bar/css/simple-sidebar.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->


    <!-- Various libraries that vA3C depends upon -->
    <script type="text/javascript" src="va3c_source_files/js/libs/dat.gui.js"></script>
    <link rel="stylesheet" type="text/css" href="va3c_source_files/css/datgui_styleOverride.css">
    <script type="text/javascript" src="va3c_source_files/js/libs/three.js"></script>
    <script type="text/javascript" src="va3c_source_files/js/libs/OrbitControls.js"></script>
    <script type="text/javascript" src="va3c_source_files/js/libs/Projector.js"></script>
    <script type="text/javascript" src="va3c_source_files/js/libs/stats.js"></script>
    <script type="text/javascript" src="va3c_source_files/js/libs/jquery-ui.js"></script>

    <!-- Application Files -->
    <link rel='stylesheet' type='text/css' href='https://rawgit.com/tt-acm/Spectacles.WebViewer/gh-pages/css/SPECTACLES.css'/>  <!-- the vA3C stylesheet -->
    <script type="text/javascript" src="https://rawgit.com/tt-acm/Spectacles.WebViewer/gh-pages/js/SPECTACLES.js"></script>  <!-- the vA3C library -->

    <!-- Pace for loading bar-->
    <link rel='stylesheet' type='text/css' href='pace/pace.css'/>
    <script type="text/javascript" src="pace/pace.min.js"></script>

    <!-- rating system -->
    <script src='./rating_source_files/jquery.rating.js' type="text/javascript" language="javascript"></script>
    <link href='./rating_source_files/jquery.rating.css' type="text/css" rel="stylesheet"/>

    <style>
        body {
           font-family: sans-serif;
           font-size: 12px;
        }
        
        div {
            overflow: hidden;
            background-color: white;
        }
        
        input {
           display: inline-block;
           font-family: sans-serif;
           font-size: 12px;
        }

        output {
            display: inline-block;
            font-size: 11px;
            font-weight: bold;
            color: red;
             }

        /* centered columns styles */
        .row-centered {
            text-align:center;
        }
        
        .col-centered {
            display:inline-block;
            float:none;
            /* reset the text-align */
            text-align:left;
            /* inline-block space fix */
            margin-right:-4px;
        }

        .vertical-center {
            min-height: 100%;  /* Fallback for browsers do NOT support vh unit */
            min-height: 100vh; /* These two lines are counted as one           */

            display: flex;
            align-items: center;
        }

        .footer {
            width: 95%;
            height: 20px;
            position: absolute;
            bottom: 10px;
            left: 10px;
        }

        .credit{
            margin-left: 1em;
            margin-bottom: .5em;
        }

        .fullscreen{
            top: 0;
            left: 0;
            height: 100% !important;
            width: 100% !important;
            position: fixed !important;
            z-index: 1001 !important;
        }

        #thumbnails-side img,
        #thumbnails-btm img {
            width: 100%;
            margin-top: 2em;
            border: .2em solid black;
            }

        #zoomed img,
        #zoomedArea img {
            height: 100%;
            width: auto;
            display:block; /* to center the imge - hopefully! */
            margin-left:auto; 
            margin-right:auto;
            }

        #thumbnails-side_container,
        #thumbnails-btm {
            overflow: auto;
            height: 100%;
        }

        rect.disabled {
            fill: transparent !important;
        }

       .navbar-default {
            height: 50px; /* overwrite default navbar size */
       }

       .Spectacles_Footer{
        visibility: hidden;
       }

    </style>

</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-default" style="margin-bottom:0">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#buttons-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <div class="navbar-header" title="Click to edit project name.">
                <p class="navbar-brand" contenteditable="true">DESIGN EXPLORER</p>
            </div>           
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="buttons-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li>
                    <!--
                    <p class="navbar-text">
                        <input type="file" id="csv-file" class="btn btn-default btn-sm" name="files"/>
                    </p>
                    -->
                </li>
                <li>
                    <div class="btn-group btn-group-sm navbar-text" role="group" aria-label="selection">
                            <button id="reset" class="btn btn-default">Reset Selection</button>
                            <button id="remove" class="btn btn-default">Exclude Selection</button>
                            <button id="keep" class="btn btn-default">Zoom to Selection</button>
                    </div>
                </li>
                <li>
                    <p class="navbar-text">
                        <button id="savecsv" class="btn btn-default btn-sm" onclick = saveToCSV()>Save Selection to File</button>
                    </p>
                </li>
                <li>
                    <a class="navbar-brand" href="http://core.thorntontomasetti.com/" title="@CORE Studio">
                        <img style="max-width:350px;"
                        src="./img/CORE logo_horizontal.jpg">
                    </a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>

    <div id="wrapper" class="toggled">
           
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <div id= "legend-heading" class="sidebar-brand col-xs-12" style="text-align:center"></div>
                <div class="legend col-xs-12" id="legend">
                    <!--place holder for legends-->
                </div>
                <div id= "sliders-heading" class="sidebar-brand" style="text-align:center">
                    LOAD YOUR DATA!
                </div>
                <div class="inputSliders col-xs-12" id="inputSliders">
                    <form class="sliders"> <!-- I will use this form to disable all the sliders together. -->
                    </form>
                </div>
                <div id= "sliders-report" class="sidebar-brand col-xs-12" style="text-align:center"></div>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                            <div class="credit">
                                    Design Explorer &copy; Copyright 2015 CORE studio | Thornton Tomasetti |
                                    <a href="http://core.thorntontomasetti.com/about" target="_blank"> About</a> | 
                                    <a href="http://core.thorntontomasetti.com/about/services" target="_blank">Services</a> | 
                                    <a href="http://core.thorntontomasetti.com/about/contact" target="_blank">Contact</a> |
                            </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="row">
                            <div class="col-lg-9">
                                
                                <div class="row">
                                  <div class="btn-group col-xs-12">
                                    <button type="button" class="btn btn-default btn-xs" id="menu-toggle" title="Show sliders">
                                        <span class="glyphicon glyphicon-triangle-left" aria-hidden="true"></span>
                                    </button>
                                    <button type="button" class="btn btn-default btn-xs" id ="pcgraph" data-toggle="collapse">
                                        <span class="glyphicon glyphicon-triangle-bottom" aria-hidden="true"></span>
                                    </button>
                                  </div>
                                </div>
                                <!-- parallel coordinates -->
                                <div class="row-fluid">
                                    <div id="graph" class="parcoords collapse in">
                                        <!-- <h1>Parallel coordinates graph</h1> -->
                                    </div>
                                </div>
                                
                                <!-- Zoomed div for zoomed in areas -->
                                <div class="row-fluid">
                                    <div class="zoomed" id="zoomedArea" style="height:0px">

                                        <div class="pull-right" id="vis">
                                            <form>
                                                   
                                                <label><input type="radio" id="toggleView" name="visMode" value="2D" checked> 2D</label> <!-- show 2D image on load-->
                                                <label><input type="radio" id="toggleView" name="visMode" value="3D"> 3D</label>
                                                
                                                <button type="button" class="btn btn-default btn-xs" id="toggleComments" style="margin-right:10px; margin-left:5px; margin-top: 2px;" title="Add Comments">
                                                    <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                                                </button>
                                                <button type="button" class="btn btn-default btn-xs" id="fullscreentoggle" style="margin-right:10px; margin-left:5px; margin-top: 2px;" title="Full Screen Toggle">
                                                    <span class="glyphicon glyphicon-fullscreen" aria-hidden="true"></span>
                                                </button>

                                            </form>
                                            <form>
                                                <!--rating div-->
                                                <input class="star" type="radio" name="rating" value="1"/>
                                                <input class="star" type="radio" name="rating" value="2"/>
                                                <input class="star" type="radio" name="rating" value="3"/>
                                                <input class="star" type="radio" name="rating" value="4"/>
                                                <input class="star" type="radio" name="rating" value="5"/>

                                            </form>
                                        </div>
                                            <div id = "viewer3d" style="width:100%; height:100%" class="hidden">
                                                <!-- place holder for the viewer -->
                                            </div>
                                            <div class="zoomed" id = "zoomed" style="width:100%; height:100%">
                                                <!-- place holder for the image -->
                                            </div>
                                    </div>
                                </div>
                            </div> <!-- end of left side charts-->
                            
                            <div class="col-lg-3">
                                
                                <div class="row-fluid">
                                    <button type="button" class="btn btn-default btn-xs" id="rcgraph" data-toggle="collapse" data-target="#radarChart">
                                        <span class="glyphicon glyphicon-triangle-bottom" aria-hidden="true"></span>
                                    </button>
                                </div>
                                
                                <div class="row">
                                    <div id="radarChart" class="col-lg-12 collaps in center-block" style="font-size:14px; font-weight:bold">
                                        <!-- <h5>Radar Chart Place Holder</h5> -->
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-12" id="thumbnails-side_container" style="height:0px">
                                        <div id="sorting" class="col-lg-12" style="float:right; margin-top: 2px;"></div>
                                        <div id="thumbnails-side" class="col-lg-12">
                                            <!-- <p>Thumbnails on load</p> -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row-fluid col-lg-12">
                        <div class="col-lg-12" id="thumbnails-btm_container">
                            <div id="sorting" class="col-lg-12" style="float:right; margin-top: 2px;"></div>
                            <div class="col-lg-12" id="thumbnails-btm"></div>
                        </div>            
                    </div>
                </div>
            </div>
            <div class="row-fluid col-lg-12 row-centered vertical-center fullscreen" id="welcome">
                    <div class="col-lg-12 col-centered" >
                        <h1 class="text-center"> Welcome to Design Explorer!</h1>
                        <br>
                        <h4 class="text-center">
                            Design Explorer makes exploring multi-dimensional design space enjoying and meaningful!
                        </h4>
                        <br><br>
                        <h3 class="text-center"> To get started import your file</h3>
                        <br>
                        <input type="file" id="csv-file" class="btn btn-success btn-lg center-block" name="files"/>
                        <br>
                        <h3 class="text-center"> or try one of sample design sets </h3>
                        <br>
                                <button id="sample1" class="btn btn-info btn-lg center-block">Replace with image grid!</button>
                                <br>
                                <button id="sample2" class="btn btn-info btn-lg center-block">Replace with image grid!</button>
                                <br>
                                <button id="sample3" class="btn btn-info btn-lg center-block">Replace with image grid!</button>
                                <br>
                        <h2 class="text-center"> Happy Exploring! </h2>
                        <br><br>
                        <h5 class="text-center">
                            Design Explorer &copy; Copyright 2015 CORE studio | Thornton Tomasetti |
                            <a href="http://core.thorntontomasetti.com/about" target="_blank"> About</a> | 
                            <a href="http://core.thorntontomasetti.com/about/services" target="_blank">Services</a> | 
                            <a href="http://core.thorntontomasetti.com/about/contact" target="_blank">Contact</a> |
                        </h5>
                    </div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->


    <!-- Bootstrap Core JavaScript -->
    <script src="bootstrap_side_bar/js/bootstrap.min.js"></script>

    <!-- Hide sliders if user asked for a stripped down version -->
    <script type="text/javascript">
        // A dictionary to carry users input to customize the interface
        var inputParameters = { "min": false}; // currently only a single item, other options to be added later

        // get url parameters
        // current valid key is on "min" for minimum interface
        function parseUri(){
            var pars = window.location.search.replace("?","").split("&")
            if (pars[0]=="") return null;
            pars.forEach(function(d){
                keyValue = d.split("=");
                inputParameters[keyValue[0].toLowerCase()] = keyValue[1].toLowerCase();
            })
        }
        
        // read optional url parameters
        parseUri();

        if(inputParameters["min"] == 'true'){
            // remove the button so sliders are hidden
            d3.selectAll("button#menu-toggle").remove();
        }



    </script>


    <!-- Dynamic Divs script -->
    <script>
        var isAnyItemSelected = false;
        var isToggled = true;

        // side bar for sliders
        $("#menu-toggle").click(function(e) {
            e.preventDefault();

            //$("#wrapper").toggleClass("toggled");
            isToggled = !isToggled;
            d3.select("#wrapper")
                .classed("toggled", isToggled)
                .transition().duration(500) //length of toggle animation
                .each("end", function() {
                    resizeRadarChart();
                })
        });

        // toggel between selected and not selected modes
        // d3.selectAll(".thumbnail-image").on("click", updateLayout);
        
        // update layout on select
        function updateLayoutOnSelect(){
            
            var selectedImage = d3.select(this);

            // update rating based
            setStarValue(selectedImage.data()[0].Rating);
            
            // find height of parallel coordinate
            // to find the height for zoomed div
            var pcHeight = d3.select("#graph")
                .style("height").replace("px", "");

            // show zoomed area
            d3.selectAll(".zoomed")
                .transition().duration(1500)
                .style("height", (cleanHeight - pcHeight) + "px");

            // hide btm thumbnail
            d3.select("#thumbnails-btm_container")
                .transition().duration(1000)
                .style("height", "0px");

            // push the image to zoomed area
            d3.selectAll(".zoomed")
                .select("img")
                .data(selectedImage.data())
                .attr("src", selectedImage.datum()["img:Image Name"])
                .attr("title", getTitle);           

            // highlight the line graph
            graph.highlight(selectedImage.data());

            // load 3d geometry if the view is set to 3D
            if (currentView=="3D") loadNew3DModel();
            
            if (!isAnyItemSelected){
                // if there is a brushed selection
                // update the range of the sliders
                updateSlidersTickValues();
            }

            // update the values for slider
            updateSlidersValue(graph.highlight()[0]);

            // enable sliders
            enableAllSliders();

            //highlight the radar chart
            rc.highlight(selectedImage.data());

            var radarHeight = d3.select("#radarChart")
                .style("height").replace("px", "");

            // let's side thumbnail show up
            d3.select("#thumbnails-side_container")
                .transition().duration(1500)
                .style("height", (cleanHeight - radarHeight) + "px");

            isAnyItemSelected = true;

        };


        // update layout on select
        function updateLayoutOnDeselect(){

            // find height of parallel coordinate
            // to find the height for thumbnail div
            var pcHeight = d3.select("#graph")
                .style("height").replace("px", "");

            // hide zoomed area
            d3.selectAll(".zoomed")
                .transition().duration(1500)
                .style("height", "0px");

            // show btm thumbnail
            d3.select("#thumbnails-btm_container")
                .transition().duration(1000)
                .style("height", (cleanHeight - pcHeight) + "px");

            // hide side thumbnail
            d3.select("#thumbnails-side_container")
                .transition().duration(1500)
                .style("height", "0px");

            // unhighlight the line graph
            graph.unhighlight();

            // enable sliders
            disableAllSliders();

            // unhighlight the radar chart
            rc.unhighlight();

            //show radar chart
            $("#radarChart").collapse("show");

            isAnyItemSelected = false;
        };

        // hide/show parallel coordinates
        d3.select("#pcgraph").on("click", function() {
            if (cleanedData.length==0) return; // don't let the user change the size before loading the file

            var height = d3.select("#graph").style("height").replace("px", "");
            
            if (height!=0){
                // collapse
                d3.select("#graph")
                    .attr("class", "parcoords collapse 2s")
                    .transition().duration(200)
                    .style("height", "0px");

                //disable buttons
                d3.select("#reset").classed("disabled", true);
                d3.select("#remove").classed("disabled", true);
                d3.select("#keep").classed("disabled", true);


                if (graph.highlight().length!=0){
                    
                    d3.selectAll(".zoomed")
                        .transition().duration(1)
                        .style("height", cleanHeight + "px")
                        .each("end", function(){
                            // resize view
                            if(currentView=="3D"){
                                va3cViewer.viewerDiv.resize();
                            }
                        });

                    }else{

                        //mirror collapse behavior with radar chart
                        $("#radarChart").collapse("hide");
                    
                    d3.select("#thumbnails-btm_container")
                        .transition().duration(1000).style("height", cleanHeight + "px");                        
                    }

            }else{

                // collapse in
                d3.select("#graph")
                    .transition("ease out").attr("class", "parcoords collapse in")
                    .transition().duration(350)
                    //.transition().duration(2000)
                    .style("height", graphHeight + "px");

                //enable buttons
                d3.select("#reset").classed("disabled", false);
                d3.select("#remove").classed("disabled", false);
                d3.select("#keep").classed("disabled", false);

                // if there is a selecion let it in
                if (graph.highlight().length!=0){
                    d3.selectAll(".zoomed")
                        .transition().duration(2000).style("height", zoomedHeight + "px");
                    }else{

                        //mirror collapse behavior with radar chart
                        $("#radarChart").collapse("show");
                    
                        d3.select("#thumbnails-btm_container")
                            .transition().duration(1000).style("height", zoomedHeight + "px");                        
                    }
            }
        });

        //hide/show radar chart
        d3.select("#rcgraph").on("click", function() {

            if (cleanedData.length==0) return; // don't let the user change the size before loading the file
            
            var height = d3.select("#radarChart").style("height").replace("px", "");

            if (height > 1) {
                if (!isAnyItemSelected) {
                    //collapse parcoords if there is nothing selected
                    d3.select("#graph")
                        .attr("class", "parcoords collapse 2s")
                        .transition().duration(200)
                        .style("height", "0px");

                    //disable buttons
                    d3.select("#reset").classed("disabled", true);
                    d3.select("#remove").classed("disabled", true);
                    d3.select("#keep").classed("disabled", true);

                    d3.select("#thumbnails-btm_container")
                        .transition().duration(1000).style("height", cleanHeight + "px");
                }

                //collapse radar chart
                $("#radarChart").collapse("hide");

            } else {
                if (!isAnyItemSelected) {
                    //expand parcoords
                    d3.select("#graph")
                        .transition("ease out").attr("class", "parcoords collapse in")
                        .transition().duration(350)
                        //.transition().duration(2000)
                        .style("height", graphHeight + "px");

                    //enable buttons
                    d3.select("#reset").classed("disabled", false);
                    d3.select("#remove").classed("disabled", false);
                    d3.select("#keep").classed("disabled", false);

                    d3.select("#thumbnails-btm_container")
                            .transition().duration(1000).style("height", zoomedHeight + "px");
                }
                
                //expand radar chart
                $("#radarChart").collapse("show");
            }
        })


    </script>

    <!-- radar chart -->
    <script type="text/javascript">

        // update radar chart
        function updateRadarChart(){
            //format data for radar chart
            var outputKeys = d3.keys(outputData[0]);
            if (graph.brushed().length > 0) {
                var selectedData = graph.brushed();
            } else {
               var selectedData = graph.data();
            }
            //var selectedData = graph.brushed();
            selectedDataFormatted = [];

            selectedData.forEach(function(d) {
                selectedDataFormatted.push(formatData(d));
            })

            //get height, width for radar chart
            //we want the graph to be centered above the thumbnails
            //65px is to fit text
            var divWidth = d3.select("#thumbnails-side").style("width").replace("px", "");
            var pcHeight = d3.select("#graph").style("height").replace("px", "");
            var rcDimension = Math.min(pcHeight, divWidth) - 65;

            radarGrey = "rgb(160,160,160)";

            //configure radar chart
            cfg = ({
                w: rcDimension,
                h: rcDimension,
                color: function(d) { return radarGrey; },
                radius: 4,
                maxValue: 100,
                extraWidthX: divWidth - rcDimension, 
                extraWidthY: 65,
                translateX: (divWidth - rcDimension) / 2, 
                translateY: 65 / 2,
                levels: 5,
            });

            RadarChart.draw("#radarChart", selectedDataFormatted, cfg);

            //move lines to back
            d3.selectAll(".area").moveToBack();

            //did not work using CSS
            d3.selectAll(".rclegend")
                .style("fill", "green")
                .style("font-size", 9);
        }

        //resize radar chart
        function resizeRadarChart() {
            
            var divWidth = d3.select("#thumbnails-side").style("width").replace("px", "");
            var pcHeight = d3.select("#graph").style("height").replace("px", "");
            if (pcHeight > 0) {
                var rcDimension = Math.min(pcHeight, divWidth) - 65;
            } else {
                var rcDimension = divWidth - 65;
            }
            
            cfg.w = rcDimension;
            cfg.h = rcDimension;
            cfg.extraWidthX = divWidth - rcDimension;
            cfg.translateX = (divWidth - rcDimension) / 2;
            cfg.transitionDuration = 0;

            RadarChart.draw("#radarChart", selectedDataFormatted, cfg);

            //move lines to back
            d3.selectAll(".area").moveToBack();

            //did not work using CSS
            d3.selectAll(".rclegend")
                .style("fill", "green")
                .style("font-size", 9);

            if (graph.brushed().length > 0) {
               rc.updateData(graph.brushed()); 
           }
            

            if (graph.highlighted().length > 0) {
                rc.highlight(graph.highlighted());
            }

        }

        // clean radar chart
        function cleanRadarChart() {
            d3.selectAll(".radar-chart").remove();
        }

    </script>


    <!-- process input data -->
    <script type="text/javascript">
        // this script imports the csv file and does the initial data processing
        // such as separating inputs, outputs, images, etc.
        var originalData, //csv as it is imported
            cleanedData = [], //all the columns to be used for parallel coordinates
            inputData = [],  // columns with input values - to be used for sliders
            outputData = [], // columns with output values - to be used for radar graph
            slidersInfo = [], // {name:'inputName', tickValues : [sorted set of values]},
            currentSliderValues = {}, // collector for values 
            allDataCollector = {},
            slidersMapping = {}, // I collect the data for all the input sliders here so I can use it to remap the sliders later
            ids = []; // Here I collect all data based on a unique ID from inputs


        function analyzeInputData(originalData){
            var keys = d3.keys(originalData[0]);

            originalData.forEach(function(row, rowCount){
                
                var inputParams = {},
                    outputParams = {},
                    cleanedParams = {};

                keys.forEach(function(key, i){
                    
                    if (key.startsWith("in:")){
                    
                        inputParams[key.replace("in:", "")] = row[key];
                        cleanedParams[key.replace("in:", "")] = row[key];
                    
                    }else if(key.startsWith("out:")){
                    
                        outputParams[key.replace("out:", "")] = row[key];
                        cleanedParams[key.replace("out:", "")] = row[key]; 
                    
                    }else{
                        cleanedParams[key] = row[key]; // I need to add case for image and 3D here later
                    }
                });

                var id = getCaseId(inputParams);

                ids.push(id);

                allDataCollector[id] = {};
                //allDataCollector[id]["inputData"] = inputParams; //don't need them for now
                //allDataCollector[id]["outputParams"] = outputParams;
                allDataCollector[id]["cleanedParams"] = cleanedParams;

                inputData.push(inputParams);
                outputData.push(outputParams);
                cleanedData.push(cleanedParams);
            });
        
        // add rating of 0 to all the options if not already there
        if (keys.indexOf("Rating")==-1) {

            cleanedData.forEach(function(d){
                d.Rating = 0;
            });
        }

        }

        function getCaseId(inputParams){
            // create the id based on inputs
            var params = [];
            d3.keys(inputParams).forEach(function(key){
                // remove spaces
                //var k = key.replace(/\s/g, '');
                // convert to numbers and back to string
                // so zeros doesn't make inconsistency
                if (isNaN(inputParams[key])){
                    var value = inputParams[key];
                }else{
                    var value = parseFloat(inputParams[key]);
                }
                
                // add them to params
                //params.push(k);
                params.push(value);
            });

            // join all of them together
            var id = params.join("");
            return id;
        }

        function prepareSlidersInfo(){
            var sliderNames = d3.keys(inputData[0]);
            var tickValues = {};
            var originalTickValues = {}; // keep track of original values

            // create an object with place holder for tickValues
            sliderNames.forEach(function(name){
                originalTickValues[name]= [];
                tickValues[name] = [];
                slidersMapping[name] = {};
            });
          
            // find tick values
            inputData.forEach(function(d, i){
                sliderNames.forEach(function(name){
                    // check if the value is already in list - add it to the list if not
                    if(tickValues[name].indexOf(d[name])==-1){
                        slidersMapping[name][d[name]] = []; // create an empty list for this value
                        tickValues[name].push(d[name]);
                        originalTickValues[name].push(d[name]);
                    }
                    
                    //add the new combination to the list
                    slidersMapping[name][d[name]].push(cleanedData[i]);
                });
            });

            // sort values and collect them
            sliderNames.forEach(function(name){
                var tValues = tickValues[name].sort();
                var oValues = originalTickValues[name].sort();
                slidersInfo.push({name: name, originalTickValues:oValues , tickValues: tValues});

            });

            // take care of whitespace in slider names! oh people...
            slidersInfo.forEach(function(d){d.namewithnospace = d.name.replace(/\s/g, '');});
        }

    </script>

    <!-- draw parallel coordinates graph -->
    <script type="text/javascript">
        var graph;

        //set up heights of divs
        var windowWidth = window.innerWidth,
            windowHeight = window.innerHeight
            cleanHeight = windowHeight - 85 - 24 // 2
            cleanWidth = windowWidth - 100,
            graphHeight = cleanHeight/3,
            zoomedHeight = cleanHeight - graphHeight,
            opacity = .7;

        function drawParallelCoordinates(){
            // set the height for graph div - this is critical otherwise
            // parallel coordinates graph will be drawn by height of 0px
            d3.select("#graph").style("height",  graphHeight + "px");
            
            // draw parallel coordiantes chart
            // click event should highlight the image in thumbnails and show it in zoomed
            // brush should filter thumbnails
            // get parallel coordinates         
            graph = d3.parcoords()('#graph')
                .data(cleanedData)
                    .margin({ top: 50, left: 20, bottom: 10, right: 20 })
                    .alpha(0.6)
                    .mode("queue")
                    .rate(5)
                    .color("grey")
                    .render()
                    .brushMode("1D-axes")  // enable brushing
                    .interactive()
                    .reorderable()
                    .scale("Rating", [0,5]).updateAxes(); // set initial domain for rating
            
            // modify labels
            var inputLabelColor = "tomato",
                outputLabelColor = "green",
                inputLabels = d3.keys(inputData[0]),
                outputLabels = d3.keys(outputData[0])
                colorset = [];

            d3.selectAll("text.label")
                // move every other label up
                .attr("transform", function(d,i){return "translate (0 , -" + (10 + ((i%2) * 15)) + ")"})
                .style("fill", function(d){
                        // change colors for inputs vs outputs
                        if (inputLabels.indexOf(d) != -1) {
                            colorset.push(inputLabelColor);
                            return inputLabelColor; // it is an input

                        } else if (outputLabels.indexOf(d) != -1) {
                            colorset.push(outputLabelColor);
                            return outputLabelColor; //it's an output
                        
                        } else {
                            // undefined
                            colorset.push("black");
                            return "black";
                        };
                    });

            
            //modify axes
            d3.selectAll("path.domain")
                .style("stroke", function(d,i){ return colorset[i];});
        };
        
        function updateLabels(){
            d3.selectAll("text.label")
                // move every other label up
                .attr("transform", function(d,i){return "translate (0 , -" + (10 + ((i%2) * 15)) + ")"})
        };

    </script>
    
    <!-- draw legend -->
    <script type="text/javascript">

        function drawLegend(){

            // add text
            d3.select("#legend-heading").text("LEGEND");

            // get width and height for legend area
            var legendWidth = d3.select("#legend").style("width").replace("px", "");
            var legendHeight = d3.select("#sidebar-wrapper").style("height").replace("px", "")/3;
            
            // legend boxes are diminsions of the graph
            dimensions = graph.dimensions().map(function(d){return {name: d, enabled:true};});

            // find size of the square based on the height
            var legendSquareSize = 16; //Math.max(legendHeight/(graph.dimensions().length + 4), 12);

            // create one group for each rect and text
            var legend = d3.select("#legend").append("svg")
                .attr("width", legendWidth)
                .attr("height", legendHeight)
                .selectAll("g")
                .data(dimensions)
                .enter().append("g")
                    .attr("transform", function(d, i) { return "translate(10," + ((legendSquareSize + 3) * i)  + ")"; });

            legend.append("rect")
                .attr("width", legendSquareSize)
                .attr("height", legendSquareSize)
                .attr("class", "legend")
                .style("fill", "grey")
                .style("stroke", "black")
                .style("stroke-width", 1)
                .style("cursor", "pointer");

            legend.append("text")
                .attr("x", legendSquareSize + 6)
                .attr("y", legendSquareSize/2)
                .attr("dy", ".35em")
                .text(function(d) { return d.name;});
        }

    </script>

    <!-- add sorting dropdowns -->
    <script type="text/javascript">
        
        function addSortDropdowns(){
            
            sortBy = graph.dimensions()[0]; // will be used to sort thumbnail images
            ascending = true;
            
            var select = d3.selectAll("#sorting")
                .text("Sort by: ")
                .append("select")
                .attr("class", "btn btn-default btn-xs");

            // add options based on input and outputs
            select.selectAll("option")
              .data(graph.dimensions())
              .enter()
                .append("option")
                .attr("value", function (d) { return d; })
                .text(function (d) { return d; });
            
            // add change event to resort images
            select.on("change", function(d) {
                sortBy = d3.select(this).property("value");
                updateImageGrid(graph.brushed());
            })

            // add option to reverse sorting order
            var sortingBtn = d3.selectAll("#sorting")
                .append("button")
                .attr("type", "button")
                .attr("class", "btn btn-default btn-xs")
                .attr("id", "reverseSortOrder")
                .attr("title", "Reverse sorting order")
            
            // append icon
            sortingBtn.append("span")
                .attr("class", "glyphicon glyphicon-circle-arrow-up")
                .attr("aria-hidden", "true");

            sortingBtn.on("click", function(){
                ascending = !ascending;
                
                d3.select(this)
                    .select("span")
                        .attr("class", function(){ return ascending? "glyphicon glyphicon-circle-arrow-up":"glyphicon glyphicon-circle-arrow-down"})
                
                updateImageGrid(graph.brushed());
            });
        }

    </script>

    <!-- add thumbnail images to both thumbnail divs-->
    <script type="text/javascript">

        function getTitle(data){

            // get title for each image    
            var title = [];
            
            graph.dimensions().forEach(function(key){
                var info =  key + ":" + data[key];
                title.push(info);
            });

            return title.join(" | ");

            //return title.join(" &#013; "); //I tried to add them for each line but it didn't work
        }

        function updateImageGrid(data){
            
            // this is based on bootstraps 12 column grid
            // we can replace it with a fancier version later
            var gridSizes = [1, 2, 3, 4, 6];
            var fgridSize = 1; //gridSizes[gridSize];
            
            if (!data) data= graph.data(); //if data is false then use graph data

            // sort data based on dropdown selecion
            if(ascending){
                data.sort(function(x, y){
                    return d3.ascending(parseFloat(x[sortBy]), parseFloat(y[sortBy]));
                });
            }else{
                data.sort(function(x, y){
                    return d3.descending(parseFloat(x[sortBy]), parseFloat(y[sortBy]));
                });
            }

            // remove all the current divs
            // I think eventually I will change this to a filter function
            d3.select("#thumbnails-btm").selectAll("div").remove();
            d3.select("#thumbnails-side").selectAll("div").remove();
            
            var pcHeight = d3.select("#graph")
                .style("height").replace("px", "");

            d3.select("#thumbnails-btm_container")
                .style("height", (cleanHeight - pcHeight) + "px");

            // attach images
            d3.select("#thumbnails-btm")
                //.style("height", "100%") //20px for credit line - 
                .selectAll("div")
                .data(data).enter()
                    .append("div")
                    .attr("class", "col-xs-1")
                    .style("cursor", "pointer")
                    .append("img")
                    .attr("id", "thumbnails-btm")
                    .attr("src", function(d){return d["img:Image Name"]})
                    .on("click", updateLayoutOnSelect)
                    .attr("title", getTitle);
            
            d3.select("#thumbnails-side")
                .selectAll("div")
                .data(data).enter()
                    .append("div")
                    .attr("class", "col-xs-3")
                    .style("cursor", "pointer")
                    .append("img")
                    .attr("id", "thumbnails-side")
                    .attr("src", function(d){return d["img:Image Name"]})
                    .on("click", updateLayoutOnSelect)
                    .attr("title", getTitle);
        }


        function addPlaceHolderImage(){
            // add an image holder with toggle between 2D and 3D
            // just toggle between 2d and 3d
            d3.select("#zoomed")
            .style("height", zoomedHeight)
            .append("img")
            .attr("src", "https://raw.githubusercontent.com/tt-acm/DesignExplorer/gh-pages/design_explorer_data/img/placeholder/placeholder.png?token=ACx89Xl7jGRusi88wWHKH97INGjRifH5ks5Vy6YGwA%3D%3D");
        }

    </script>
   
    <!-- set up events between charts and graphs -->
    <script type="text/javascript">
        
        function setupEvents(){

            // brushing events for parallel coordinates graph
            graph.on("brush", function(d) {
                rc.updateData(graph.brushed());
                updateImageGrid(d);
                
            });

             graph.on("brushend", function(d){

                // if nothing is highlighted return                                
                if (graph.highlight().length==0) return;

                // in case highlighted data not in brused then deselect
                if (graph.brushed().length == inputData.length || graph.brushed().indexOf(graph.highlight()[0])==-1){
                        updateLayoutOnDeselect();
                }
            });
            
            
            // assign buttons
            // Keep brushed
            d3.select("#keep")
                .on("click", function() {

                    var newData = graph.brushed();
                    
                    if (newData == false || newData.length == 0){
                        alert("You need to select some data to be kept!")
                    }else{
                        // update graph with new data
                        updateGraph(newData);
                    }
                });

            d3.select("#remove")
                .on("click", function() {
                    
                    var selectedData = graph.brushed();
                    
                    if (selectedData == false || selectedData.length == 0){
                        alert("You need to select some data to be removed!")
                    }else{
                        // update graph with new data
                        var newData = graph.data().filter(function(d){return selectedData.indexOf(d)==-1;});
                        updateGraph(newData);
                    }
                });

            // go back to original
            d3.select("#reset")
                .on("click", function() {           
                    updateGraph(cleanedData);
                });


            function updateGraph(newData){
                graph.data(newData).render().interactive().reorderable().autoscale();
                updateRadarChart();
                updateLayoutOnDeselect();                        
                updateImageGrid(newData);
                updateSlidersTickValues();
            }
            
            
            d3.selectAll("rect.legend").on('click', function(d) {
                    var rect = d3.select(this);
                    var name = d.name;
                    var enabled = true;
                    

                    if (rect.attr('class') === 'legend disabled')
                        {
                            rect.attr('class', 'legend');
                        }
                    else
                        {
                            rect.attr('class', 'legend disabled');
                            enabled = false;
                        }

                    // update dimensions
                    dimensions.forEach(function(dim){if (d.name === name) d.enabled = enabled;});

                    // get active dimensios to update parallel coordinate charts
                    var activeDimensions = dimensions.filter(function(d){return (d.enabled) ? 1 : 0}).map(function(d){return d.name});
                    
                    graph.dimensions(activeDimensions);

                    if(graph.highlighted().length!=0) graph.highlight(graph.highlighted());
                });

            

            //turn off rating rectangle
            d3.selectAll("rect.legend")
                .attr("class", function(d){ 
                    
                    if (d.name=="Rating"){
                        d.enabled = false;
                        return 'legend disabled';
                    }
                });
            
            // remove Rating for on page load
            var activeDimensions = dimensions.filter(function(d){return d.name!="Rating";}).map(function(d){return d.name;});
            graph.dimensions(activeDimensions);

            }

    </script>

    <!-- import data -->
    <script>
        // read input data
        window.onload = function() {

            var fileInput = document.getElementById('csv-file');
            
            fileInput.addEventListener('change', function(e) {
                
                var file = fileInput.files[0];
                var reader = new FileReader();
                
                var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
                    

            if (regex.test(file.name.toLowerCase())) {
                
                // Update project name
                var inputFileName = file.name.toUpperCase().replace(".CSV","");

                d3.select("p.navbar-brand").text(inputFileName);

                reader.onload = function(e) {
                
                    var inputString = e.target.result; 

                    // I need to add some defense here
                    // separateInputOutputs(e);
                    
                    var data = d3.csv.parse(inputString);

                    //originalDataLength = data.length;

                    if (data==null) return; // loading .csv file failed for some reason

                    // remove welcome div
                    d3.select("#welcome").remove();
                    
                    // analyze data and separate them as input/output and general data
                    analyzeInputData(data);

                    // get sliders information based on input data
                    prepareSlidersInfo();

                    // add sliders to the page
                    initiateSliders();

                    // draw parallel coordinates graph
                    drawParallelCoordinates();

                    //draw radar chart
                    updateRadarChart();

                    // draw legend in side bar
                    drawLegend();

                    // add sorting divs
                    addSortDropdowns();

                    // add thumbnails
                    updateImageGrid(graph.data());

                    // add place holder image to zoomed area
                    addPlaceHolderImage();

                    // set up events between graphs
                    setupEvents();
                }


            }else{
                    alert("Please upload a valid CSV file!");
                }

                reader.readAsText(file);
            });

        }; // end of window.onload
    </script>

    <!-- Setting up sliders -->
    <script type="text/javascript">

        function initiateSliders(){
            // this just runs first onload of the page
            // all the sliders should be disabled on load until the user select one of the options
            d3.select(".sidebar-brand").text("INPUT SLIDERS");

            // insert divs for sliders
            d3.selectAll("#inputSliders")
                .selectAll("div")
                .data(slidersInfo).enter()
                .append("div")
                    .attr("class", "inputSlider") // full width
                    .text(function(d){return d.name})
                    .append("input")
                    .attr("id", function(d){return d.namewithnospace})
                    .attr("name", function(d){return d.name});
            

            // if number of ticks is less than 7 then show the numbers under slider
            var showGrid = function(info){return info.tickValues.length < 7;}

            // set up slider properties
            // they will be all set to disabled until user selects one option
            slidersInfo.forEach(function(info, i){
                
                $("#" + info.namewithnospace).ionRangeSlider({
                    grid: showGrid(info),
                    prettify_separator: ",",
                    values:info.tickValues,
                    disable: true,
                    onChange: function (data) {
                            // remove white spaces
                            // var sliderName = data.input[0].name.replace(/\s/g, '');
                            updateSliderValue(data.input[0].name, data.from_value);
                    }
                
               });
            });
        }

        function updateSlidersTickValues(){

            // This function only gets called once there is a new selection
            // and for major changes in data selection (reset/exclude/zoom to selection)
            // don't call this frequently as this is a fairly expensive run


            // I need to re-visit this
            if (graph.brushed()==[] || graph.brushed().length == inputData.length){
                // go back to default
                // disable all sliders once no option is selected
                slidersInfo.forEach(function(info){                       
                    $("#" + info.namewithnospace).data("ionRangeSlider")
                        .update({values:info.originalTickValues});
            });

            }else{

                var tickValues = {};
                
                slidersInfo.forEach(function(info){tickValues[info.name] = []}); //create an empty list for each slider

                if (!graph.brushed()){
                    // in case graph is just rendered
                    var data = graph.data();    
                }else{
                    var data = graph.brushed();
                }

                // find tick values
                data.forEach(function(d){
                    slidersInfo.forEach(function(info){
                        // check if the value is already in list - add it to the list if not
                        if(tickValues[info.name].indexOf(d[info.name])==-1) tickValues[info.name].push(d[info.name]);
                    });
                });

                
                slidersInfo.forEach(function(sliderInfo){

                    var sliderName = sliderInfo.name;
                    // remove spaces
                    var namewithnospace = sliderName.replace(/\s/g, '');
                    var newTickValues = tickValues[sliderName].sort();

                    // update values in sliderInfo
                    sliderInfo.tickValues = newTickValues;

                    $("#" + namewithnospace).data("ionRangeSlider")
                        .update({values: newTickValues});
               });

                // update current values
                updateSlidersValue(graph.highlighted()[0]);

            }
        }


        function disableAllSliders(){
            // disable all sliders once no option is selected
            slidersInfo.forEach(function(info){                       
                $("#" + info.namewithnospace).data("ionRangeSlider")
                    .update({disable: true});
            });
        }

        
        function enableAllSliders(){
            // enable all sliders once an option is selected
            // This will be called after selecting a new option
            slidersInfo.forEach(function(info){                       
                $("#" + info.namewithnospace).data("ionRangeSlider")
                    .update({disable: false});
            });
        }

        function updateSlidersValue(data){
            
            // clear report area
            d3.selectAll("#sliders-report").text("");

            // update the value of all the sliders based on an input object
            // this function will be called when a new option is selected by user
            slidersInfo.forEach(function(info){

                if (isNaN(data[info.name])){
                    var value = data[info.name]; // if a number
                }else{
                    var value = parseFloat(data[info.name]); // otherwise
                }

                currentSliderValues[info.name] = value;

                $("#" + info.namewithnospace).data("ionRangeSlider")
                    .update({
                        from: info.tickValues.indexOf(value), //update the value
                    });
            });
        }
        

        function updateSliderValue(changedSliderName, newValue){
            // This function update the value for a single slider
            // All the sliders call this function on update
            if (!isNaN(newValue)) currentSliderValues[changedSliderName] = newValue;

            // create the id
            var id = getCaseId(currentSliderValues);
            
            if (ids.indexOf(id)!=-1){

                var selectedData = allDataCollector[id].cleanedParams;
                
                // update chart
                graph.highlight([selectedData]);

                //update radar chart
                rc.highlight([selectedData]);

                // push the image to zoomed area
                d3.selectAll(".zoomed")
                    .select("img")
                    .attr("src",  selectedData["img:Image Name"]);
                
                if (currentView=="3D") loadNew3DModel();
                
                d3.selectAll("#sliders-report").text("");

                }else{

                    // try to remap the values based on slider value
                    var possibleCombinations = slidersMapping[changedSliderName][newValue];
                    
                    if (possibleCombinations.length==1){
                        // there is only one combination update the values to the new combination
                        updateSlidersValue(possibleCombinations[0]);
                    
                    }else{
                        
                        // sort them based on distance to current values
                        possibleCombinations.sort(function(x, y){
                            return d3.ascending(distanceFromCurrent(x), distanceFromCurrent(y));
                        });

                                               
                        // if it is in the seletion then change the sliders to that value
                        var selectedData = graph.brushed();

                        if(!selectedData) selectedData = graph.data();

                        for (var i=0; i<possibleCombinations.length; i++){
                            var combination = possibleCombinations[i];
                            if (selectedData.indexOf(combination)!=-1){
                                updateSlidersValue(combination);
                                // console.log(i);
                                break;
                            }
                        }
                    }
                    
            }
        }

        function distanceFromCurrent(sliderValues){
            var distance = 0;

            slidersInfo.forEach(function(info){
                var tValues = info.originalTickValues;               
                var d = tValues.indexOf(currentSliderValues[info.name]) - tValues.indexOf(sliderValues[info.name])
                distance += Math.abs(d);
            });


            return distance;

        }

    </script>

    <!-- 3D Viewer -->
    <script type="text/javascript">
        var currentView = "2D";
        var initit3DViewer = true;
        var fullscreen = false;

        // Initiate 3D viewer
        function initiate3DViewer(){
        
            var viewerId = "viewer3d";
            var jsonFileAddress = graph.highlighted()[0].threeD;
            
            //load JSON file
            d3.json(jsonFileAddress, function( data ){
                //Initialize a VA3C viewer
                va3cViewer = new SPECTACLES($("#" + viewerId), data, function(app){
                    //call the UI / functionality modules
                    app.setBackgroundColor(0xFFFFFF);
                });
            });
        }

        // load new models
        function loadNew3DModel(){

            d3.json(graph.highlighted()[0].threeD, function (data){
                va3cViewer.loadNewModel(data);
            });
        }


        // toggle between 2d and 3d
        d3.selectAll("input#toggleView")
          .on("change", toggleView)

        function toggleView() {

            currentView = this.value;

            if (currentView=="3D" && initit3DViewer){
                
                initit3DViewer = false;
                
                // initiate the viewer
                initiate3DViewer()

            } else if (currentView=="3D") {

                // user is changing to 3D view so let's load it.
                //$.when(loadNew3DModel()).then(va3cViewer.viewerDiv.resize());
                loadNew3DModel();          
            }

            
            var onOff = {"2D": ["zoomed", "viewer3d"], "3D": ["viewer3d", "zoomed"]};
            
            d3.select("#" + onOff[currentView][0])
                .attr("class", "zoomed");
            
            d3.select("#" + onOff[currentView][1])
                .attr("class", "zoomed hidden");

            // remove spectacles footer
            d3.select(".Spectacles_Footer").remove();
            
            // resize the view
            va3cViewer.viewerDiv.resize();

          }


        // active and de-activate full screen mode
        d3.select("button#fullscreentoggle")
            .on("click", toggleFullscreen);
        

        function toggleFullscreen(){

            fullscreen = !fullscreen;

            // select zoomed Div and change style
            d3.select("#zoomedArea")
                .attr("class", function(){return fullscreen? "zoomed fullscreen":"zoomed"});

            //make sure width and height are 100%

            d3.select("#viewer3d")
                .style("width", "100%")
                .style("height", "100%");

            d3.select("#zoomed")
                .style("width", "100%")
                .style("height", "100%");
            
            //change full screen icon
            d3.select("button#fullscreentoggle").select("span")
                .attr("class", function(){
                    return fullscreen? "glyphicon glyphicon-resize-small":"glyphicon glyphicon-fullscreen"
                });

            initit3DViewer? 0:va3cViewer.viewerDiv.resize();

        }

    </script>

    <script type="text/javascript">
        // Rating system
        var firstRating = true;

        // submit the value on change
        $('.star').rating({
            callback: function(value, link){
            // 'value' is the value selected
            if (firstRating==true){
                
                //turn on rating rectangle
                d3.selectAll("rect.legend")
                    .attr("class", function(d){ 
                        
                        if (d.name=="Rating"){
                            d.enabled = true;
                            return 'legend';
                        }
                    });

                // add Rating to dimensions
                graph.dimensions(graph.dimensions().concat("Rating"));

                firstRating = false;
            }

            // check if this is the first rating

            // update rating value
            graph.highlighted()[0].Rating = value;

            // this method is not really optimized. I couldn't find a solution just to change
            // extent of dimensions for just rating axis            
            graph.data(graph.data()).render().interactive().reorderable();

            // highlight selected option
            graph.highlight(graph.highlighted());

            }
        });


        // set the value for rating based on the current value
        function setStarValue(value){

            // remove any current value
            $('.star').data('rating').current=undefined; // set current value to undefined
            
            // set current value to undefined            
            var offClass = "star-rating rater-0 star star-rating-applied star-rating-live";
            var onClass = offClass + " star-rating-on";

            //select rating divs
            d3.selectAll("div.star-rating")
                .attr("class", function(d, i){return i<value? onClass:offClass;});

            }
    </script>


    <script type="text/javascript">

        function saveToCSV(){
            
            // modified from http://stackoverflow.com/questions/14964035/how-to-export-javascript-array-info-to-csv-on-client-side
            var data = graph.brushed()==false? graph.data(): graph.brushed();
            

            var csvContent = "data:attachment/csv;charset=utf-8,";
            
            csvContent += d3.keys(data[0]).join(",") + "\n" //add first row
            
            data.forEach(function(infoArray, index){
                dataString = d3.values(infoArray).join(",");
                csvContent += index < data.length ? dataString+ "\n" : dataString;

            }); 
            
            csvContent = encodeURI(csvContent);

            var a = d3.select("body")
                    .append("a")
                    .attr("href", csvContent)
                    .attr("target", '_blank')
                    .attr("download",'DesignExplorer_SelectedResults.csv');

            a[0][0].click();
        }

    </script>

</body>

</html>
